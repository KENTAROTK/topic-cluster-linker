<?php
/**
 * Plugin Name: Topic Cluster Linker
 * Description: ãƒ”ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã¨ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ã®å†…éƒ¨ãƒªãƒ³ã‚¯ã‚’è‡ªå‹•ææ¡ˆãƒ»æŒ¿å…¥ã—ã¾ã™ã€‚SEOå†…éƒ¨ãƒªãƒ³ã‚¯å¼·åŒ–ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚
 * Version: 1.0.0
 * Author: ã‚ãªãŸ
 * Text Domain: topic-cluster-linker
 * Domain Path: /languages
 * Requires at least: 5.0
 * Tested up to: 6.4
 * Requires PHP: 7.4
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 */

// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ã
if (!defined('ABSPATH')) {
    exit;
}

// ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å®šæ•°å®šç¾©
define('TCL_VERSION', '1.0.0');
define('TCL_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('TCL_PLUGIN_URL', plugin_dir_url(__FILE__));
define('TCL_PLUGIN_BASENAME', plugin_basename(__FILE__));
define('TCL_PLUGIN_FILE', __FILE__);

/**
 * ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®åˆæœŸåŒ–
 */
class TopicClusterLinker {
    
    public function __construct() {
        $this->init();
    }
    
    /**
     * ãƒ—ãƒ©ã‚°ã‚¤ãƒ³åˆæœŸåŒ–
     */
    private function init() {
        // å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        $this->load_dependencies();
        
        // ãƒ•ãƒƒã‚¯ã‚’ç™»éŒ²
        $this->setup_hooks();
        
        // å›½éš›åŒ–
        add_action('plugins_loaded', [$this, 'load_textdomain']);
    }
    
    /**
     * ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
     */
    private function load_dependencies() {
        // å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£ã—ã„é †åºã§èª­ã¿è¾¼ã¿
        $required_files = [
            'includes/logger.php',              // ãƒ­ã‚°æ©Ÿèƒ½ï¼ˆæœ€åˆã«èª­ã¿è¾¼ã¿ï¼‰
            'includes/propose-cluster.php',     // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ææ¡ˆæ©Ÿèƒ½
            'admin/settings-page.php',          // è¨­å®šç”»é¢
            'includes/keyword-suggester.php',   // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ææ¡ˆæ©Ÿèƒ½
            'admin/metabox.php',               // ãƒ¡ã‚¿ãƒœãƒƒã‚¯ã‚¹ï¼ˆæœ€å¾Œã«èª­ã¿è¾¼ã¿ï¼‰
        ];
        
        foreach ($required_files as $file) {
            $file_path = TCL_PLUGIN_DIR . $file;
            if (file_exists($file_path)) {
                require_once $file_path;
                // ãƒ­ã‚°æ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰ãƒ­ã‚°ã‚’è¨˜éŒ²
                if (function_exists('tcl_log_message')) {
                    tcl_log_message("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ: {$file}");
                }
            } else {
                add_action('admin_notices', function() use ($file) {
                    echo '<div class="notice notice-error"><p>';
                    echo sprintf('Topic Cluster Linker: å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ« %s ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', esc_html($file));
                    echo '</p></div>';
                });
                
                if (function_exists('tcl_log_message')) {
                    tcl_log_message("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: {$file}");
                }
            }
        }
    }
    
    /**
     * WordPressãƒ•ãƒƒã‚¯ã®è¨­å®š
     */
    private function setup_hooks() {
        // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æœ‰åŠ¹åŒ–ãƒ»ç„¡åŠ¹åŒ–
        register_activation_hook(TCL_PLUGIN_FILE, [$this, 'activate']);
        register_deactivation_hook(TCL_PLUGIN_FILE, [$this, 'deactivate']);
        
        // ç®¡ç†ç”»é¢ã§ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ»ã‚¹ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        add_action('admin_enqueue_scripts', [$this, 'enqueue_admin_assets']);
        
        // AJAXå‡¦ç†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼‰
        add_action('wp_ajax_tcl_regenerate_link', 'tcl_ajax_regenerate_link');
        
        // ç®¡ç†è€…é€šçŸ¥
        add_action('admin_notices', [$this, 'admin_notices']);
    }
    
    /**
     * ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æœ‰åŠ¹åŒ–æ™‚ã®å‡¦ç†
     */
    public function activate() {
        // åˆæœŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
        $this->setup_default_options();
        
        // ACFãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¢ºèª
        if (!function_exists('get_field')) {
            add_option('tcl_show_acf_notice', true);
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
        $this->create_tables();
        
        // ãƒ­ã‚°è¨˜éŒ²
        if (function_exists('tcl_log_message')) {
            tcl_log_message('Topic Cluster Linker ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ - Version: ' . TCL_VERSION);
        }
        
        // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒªãƒ©ã‚¤ãƒˆãƒ«ãƒ¼ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        flush_rewrite_rules();
    }
    
    /**
     * ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç„¡åŠ¹åŒ–æ™‚ã®å‡¦ç†
     */
    public function deactivate() {
        // ä¸€æ™‚çš„ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
        delete_option('tcl_show_acf_notice');
        
        // ãƒ­ã‚°è¨˜éŒ²
        if (function_exists('tcl_log_message')) {
            tcl_log_message('Topic Cluster Linker ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ');
        }
        
        // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒªãƒ©ã‚¤ãƒˆãƒ«ãƒ¼ãƒ«
        flush_rewrite_rules();
    }
    
    /**
     * åˆæœŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¨­å®š
     */
    private function setup_default_options() {
        $default_options = [
            'tcl_api_key' => '',
            'tcl_cluster_proposals' => [],
            'tcl_max_links_per_post' => 2,
            'tcl_auto_suggest' => true,
            'tcl_log_level' => 'info',
            'tcl_version' => TCL_VERSION,
        ];
        
        foreach ($default_options as $option_name => $default_value) {
            if (get_option($option_name) === false) {
                add_option($option_name, $default_value);
            }
        }
    }
    
    /**
     * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
     */
    private function create_tables() {
        global $wpdb;
        
        $charset_collate = $wpdb->get_charset_collate();
        
        // ãƒªãƒ³ã‚¯å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå°†æ¥ä½¿ç”¨äºˆå®šï¼‰
        $table_name = $wpdb->prefix . 'tcl_link_history';
        
        $sql = "CREATE TABLE $table_name (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            post_id bigint(20) NOT NULL,
            target_post_id bigint(20) NOT NULL,
            link_text text NOT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY post_id (post_id),
            KEY target_post_id (target_post_id)
        ) $charset_collate;";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);
    }
    
    /**
     * ç®¡ç†ç”»é¢ã‚¢ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿
     */
    public function enqueue_admin_assets($hook) {
        // æŠ•ç¨¿ç·¨é›†ç”»é¢ã®ã¿
        if (!in_array($hook, ['post.php', 'post-new.php', 'toplevel_page_topic-cluster-linker'])) {
            return;
        }
        
        // JavaScript
        wp_enqueue_script(
            'tcl-admin',
            TCL_PLUGIN_URL . 'tcl-admin.js',
            ['jquery'],
            TCL_VERSION,
            true
        );
        
        // JavaScriptç”¨ãƒ‡ãƒ¼ã‚¿
        wp_localize_script('tcl-admin', 'tcl_ajax', [
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('tcl_ajax_nonce'),
            'max_links' => get_option('tcl_max_links_per_post', 2),
            'messages' => [
                'insert_success' => __('âœ… SEOå†…éƒ¨ãƒªãƒ³ã‚¯ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ', 'topic-cluster-linker'),
                'insert_error' => __('âŒ ãƒªãƒ³ã‚¯ã®æŒ¿å…¥ã«å¤±æ•—ã—ã¾ã—ãŸ', 'topic-cluster-linker'),
                'generating' => __('ğŸ¤– GPTç”Ÿæˆä¸­...', 'topic-cluster-linker'),
                'regenerate' => __('ğŸ”„ å†ç”Ÿæˆ', 'topic-cluster-linker'),
                'communication_error' => __('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'topic-cluster-linker'),
            ]
        ]);
        
        // ç®¡ç†ç”»é¢ç”¨CSSï¼ˆã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚Œã°ï¼‰
        $css_file = TCL_PLUGIN_URL . 'admin/css/admin.css';
        if (file_exists(TCL_PLUGIN_DIR . 'admin/css/admin.css')) {
            wp_enqueue_style(
                'tcl-admin',
                $css_file,
                [],
                TCL_VERSION
            );
        }
    }
    
    /**
     * ç®¡ç†è€…é€šçŸ¥
     */
    public function admin_notices() {
        // ACFãƒ—ãƒ©ã‚°ã‚¤ãƒ³æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é€šçŸ¥
        if (get_option('tcl_show_acf_notice')) {
            if (!function_exists('get_field')) {
                echo '<div class="notice notice-warning is-dismissible">';
                echo '<p><strong>Topic Cluster Linker:</strong> ';
                echo 'ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ Advanced Custom Fields (ACF) ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å¿…è¦ã¨ã—ã¾ã™ã€‚';
                echo ' <a href="' . admin_url('plugin-install.php?s=advanced+custom+fields&tab=search&type=term') . '">ä»Šã™ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</a>';
                echo '</p>';
                echo '</div>';
            } else {
                delete_option('tcl_show_acf_notice');
            }
        }
        
        // APIã‚­ãƒ¼æœªè¨­å®šé€šçŸ¥
        if (!get_option('tcl_api_key') && $this->is_tcl_admin_page()) {
            echo '<div class="notice notice-info">';
            echo '<p><strong>Topic Cluster Linker:</strong> ';
            echo 'ChatGPT APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ã€è‡ªå‹•ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚';
            echo ' <a href="' . admin_url('admin.php?page=topic-cluster-linker') . '">è¨­å®šç”»é¢</a>';
            echo '</p>';
            echo '</div>';
        }
    }
    
    /**
     * TCLé–¢é€£ã®ç®¡ç†ç”»é¢ã‹ãƒã‚§ãƒƒã‚¯
     */
    private function is_tcl_admin_page() {
        $screen = get_current_screen();
        return $screen && (
            strpos($screen->id, 'topic-cluster-linker') !== false ||
            in_array($screen->id, ['post', 'local_trouble'])
        );
    }
    
    /**
     * å›½éš›åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ â† ã“ã®éƒ¨åˆ†ãŒæŠœã‘ã¦ã„ã¾ã—ãŸ
     */
    public function load_textdomain() {
        load_plugin_textdomain(
            'topic-cluster-linker',
            false,
            dirname(TCL_PLUGIN_BASENAME) . '/languages'
        );
    }
    
    /**
     * ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
     */
    public static function get_plugin_info() {
        return [
            'version' => TCL_VERSION,
            'dir' => TCL_PLUGIN_DIR,
            'url' => TCL_PLUGIN_URL,
            'basename' => TCL_PLUGIN_BASENAME,
        ];
    }
    
    /**
     * ãƒ‡ãƒãƒƒã‚°æƒ…å ±
     */
    public static function debug_info() {
        return [
            'php_version' => PHP_VERSION,
            'wp_version' => get_bloginfo('version'),
            'acf_active' => function_exists('get_field'),
            'api_key_set' => !empty(get_option('tcl_api_key')),
            'proposals_count' => count(get_option('tcl_cluster_proposals', [])),
        ];
    }
}

// ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
new TopicClusterLinker();

/**
 * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
 */

/**
 * ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
function tcl_get_plugin_info() {
    return TopicClusterLinker::get_plugin_info();
}

/**
 * ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
function tcl_debug_info() {
    return TopicClusterLinker::debug_info();
}

/**
 * ç¾åœ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
 */
function tcl_get_version() {
    return TCL_VERSION;
}

/**
 * ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
 */
function tcl_check_compatibility() {
    $errors = [];
    
    // PHP ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    if (version_compare(PHP_VERSION, '7.4', '<')) {
        $errors[] = 'PHP 7.4ä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚ç¾åœ¨: ' . PHP_VERSION;
    }
    
    // WordPress ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    if (version_compare(get_bloginfo('version'), '5.0', '<')) {
        $errors[] = 'WordPress 5.0ä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚ç¾åœ¨: ' . get_bloginfo('version');
    }
    
    // ACF ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    if (!function_exists('get_field')) {
        $errors[] = 'Advanced Custom Fields ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚';
    }
    
    return $errors;
}

/**
 * ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®å‡¦ç†
 */
function tcl_uninstall() {
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å‰Šé™¤
    $options_to_delete = [
        'tcl_api_key',
        'tcl_cluster_proposals',
        'tcl_max_links_per_post',
        'tcl_auto_suggest',
        'tcl_log_level',
        'tcl_version',
        'tcl_show_acf_notice',
    ];
    
    foreach ($options_to_delete as $option) {
        delete_option($option);
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤
    global $wpdb;
    $table_name = $wpdb->prefix . 'tcl_link_history';
    $wpdb->query("DROP TABLE IF EXISTS $table_name");
    
    // ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
    $upload_dir = wp_upload_dir();
    $log_file = trailingslashit($upload_dir['basedir']) . 'topic-cluster-log.txt';
    if (file_exists($log_file)) {
        unlink($log_file);
    }
}

// ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒƒã‚¯
register_uninstall_hook(__FILE__, 'tcl_uninstall');