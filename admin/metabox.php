<?php
/**
 * Topic Cluster Linker - „É°„Çø„Éú„ÉÉ„ÇØ„ÇπÊ©üËÉΩ
 * ÊäïÁ®øÁ∑®ÈõÜÁîªÈù¢„Åß„ÅÆSEOÂÜÖÈÉ®„É™„É≥„ÇØÁÆ°ÁêÜ
 */

// „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØ
if (!defined('ABSPATH')) {
    exit;
}

/**
 * „É°„Çø„Éú„ÉÉ„ÇØ„ÇπÁÆ°ÁêÜ„ÇØ„É©„Çπ
 */
class TCL_Metabox {
    
    public function __construct() {
        add_action('add_meta_boxes', [$this, 'add_metabox']);
        add_action('save_post', [$this, 'save_metabox_data'], 10, 2);
        add_action('admin_enqueue_scripts', [$this, 'enqueue_metabox_assets']);
    }
    
    /**
     * „É°„Çø„Éú„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†
     */
    public function add_metabox() {
        $post_types = apply_filters('tcl_metabox_post_types', ['post', 'local_trouble']);
        
        add_meta_box(
            'tcl-cluster-links',
            'üîó SEOÂÜÖÈÉ®„É™„É≥„ÇØÁÆ°ÁêÜ - Topic Cluster',
            [$this, 'metabox_callback'],
            $post_types,
            'side',
            'high'
        );
    }
    
    /**
     * „É°„Çø„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂÜÖÂÆπ„ÇíË°®Á§∫
     */
    public function metabox_callback($post) {
        $proposals = get_option('tcl_cluster_proposals', []);
        $current_post_id = $post->ID;
        
        // „Éä„É≥„ÇπËøΩÂä†
        wp_nonce_field('tcl_metabox_nonce', 'tcl_metabox_nonce_field');
        
        // „Çπ„Çø„Ç§„É´Âá∫Âäõ
        $this->output_metabox_styles();
        
        // „É°„Çø„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„É°„Ç§„É≥Âá¶ÁêÜ
        echo '<div class="tcl-metabox-container">';
        $this->display_metabox_content($post, $proposals);
        echo '</div>';
    }
    
    /**
     * „É°„Çø„Éú„ÉÉ„ÇØ„ÇπÁî®„Çπ„Çø„Ç§„É´
     */
    private function output_metabox_styles() {
        ?>
        <style>
            .tcl-metabox-container {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            }
            .tcl-status-box {
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 15px;
                border-left: 4px solid;
                font-size: 13px;
                line-height: 1.4;
            }
            .tcl-success {
                background: #d1edff;
                border-left-color: #0073aa;
                color: #0073aa;
            }
            .tcl-warning {
                background: #fff3cd;
                border-left-color: #ffc107;
                color: #856404;
            }
            .tcl-error {
                background: #f8d7da;
                border-left-color: #dc3545;
                color: #721c24;
            }
            .tcl-link-box {
                border: 1px solid #ddd;
                padding: 12px;
                margin-bottom: 12px;
                background: #f9f9f9;
                border-radius: 6px;
                transition: box-shadow 0.2s;
            }
            .tcl-link-box:hover {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .tcl-link-title {
                font-weight: 600;
                color: #23282d;
                margin-bottom: 6px;
                font-size: 14px;
            }
            .tcl-keywords {
                font-size: 11px;
                color: #666;
                margin-bottom: 8px;
                font-style: italic;
            }
            .tcl-preview {
                font-size: 12px;
                line-height: 1.5;
                margin: 8px 0;
                padding: 10px;
                background: white;
                border: 1px solid #e1e1e1;
                border-radius: 4px;
                border-left: 3px solid #0073aa;
                min-height: 40px;
            }
            .tcl-button-group {
                margin-top: 10px;
                display: flex;
                gap: 8px;
            }
            .tcl-button {
                border: none;
                padding: 8px 14px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 500;
                transition: all 0.2s;
            }
            .tcl-button-primary {
                background: #0073aa;
                color: white;
            }
            .tcl-button-primary:hover {
                background: #005a87;
                color: white;
            }
            .tcl-button-secondary {
                background: #6c757d;
                color: white;
            }
            .tcl-button-secondary:hover {
                background: #545b62;
                color: white;
            }
            .tcl-section-title {
                font-size: 14px;
                font-weight: 600;
                color: #23282d;
                margin: 20px 0 12px 0;
                padding-bottom: 8px;
                border-bottom: 2px solid #0073aa;
            }
            .tcl-stats-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 15px;
            }
            .tcl-stat-item {
                text-align: center;
                padding: 8px;
                background: #f1f1f1;
                border-radius: 4px;
                font-size: 12px;
            }
            .tcl-stat-number {
                display: block;
                font-size: 18px;
                font-weight: bold;
                color: #0073aa;
            }
            .tcl-no-clusters {
                text-align: center;
                padding: 20px;
                color: #666;
                font-style: italic;
            }
            .tcl-help-text {
                font-size: 11px;
                color: #666;
                margin-top: 8px;
                line-height: 1.4;
            }
            .tcl-pillar-link {
                color: #0073aa;
                text-decoration: none;
                font-weight: 500;
            }
            .tcl-cluster-creation-box {
                border: 1px solid #0073aa;
                padding: 15px;
                background: #f0f8ff;
                border-radius: 6px;
                margin-top: 15px;
            }
        </style>
        <?php
    }
    
    /**
     * „É°„Çø„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑË°®Á§∫
     */
    private function display_metabox_content($post, $proposals) {
        $current_post_id = $post->ID;
        
        // „Éà„Éî„ÉÉ„ÇØ„ÇØ„É©„Çπ„Çø„ÉºÈñ¢‰øÇ„ÅÆÂàÜÊûê
        $cluster_analysis = $this->analyze_post_cluster_relationship($current_post_id, $proposals);
        
        if (!$cluster_analysis['is_in_cluster']) {
            $this->display_no_cluster_message();
            return;
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        $this->display_cluster_status($cluster_analysis);
        
        // „É™„É≥„ÇØÁµ±Ë®à
        $this->display_link_statistics($cluster_analysis);
        
        // „É™„É≥„ÇØÂÄôË£úË°®Á§∫
        if ($cluster_analysis['remaining_links'] > 0) {
            $this->display_link_candidates($post, $cluster_analysis);
        } else {
            $this->display_max_links_reached();
        }
        
        // „Éò„É´„Éó„ÉÜ„Ç≠„Çπ„Éà
        $this->display_help_text();
    }
    
    /**
     * ÊäïÁ®ø„ÅÆ„ÇØ„É©„Çπ„Çø„ÉºÈñ¢‰øÇ„ÇíÂàÜÊûê
     */
    private function analyze_post_cluster_relationship($post_id, $proposals) {
        $analysis = [
            'is_in_cluster' => false,
            'is_pillar' => false,
            'pillar_id' => null,
            'pillar_title' => '',
            'available_clusters' => [],
            'existing_links' => 0,
            'remaining_links' => 0,
            'max_links' => get_option('tcl_max_links_per_post', 2),
        ];
        
        // „Éî„É©„Éº„Éö„Éº„Ç∏„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà‰øÆÊ≠£ÁâàÔºâ
        $pillar_keywords = get_field('pillar_keywords', $post_id);
        if ($pillar_keywords) {
            $analysis['is_in_cluster'] = true;
            $analysis['is_pillar'] = true;
            $analysis['pillar_id'] = $post_id;
            $analysis['pillar_title'] = get_the_title($post_id);
            // „ÇØ„É©„Çπ„Çø„Éº„Åå„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇÁ©∫ÈÖçÂàó„ÇíË®≠ÂÆö
            $analysis['available_clusters'] = isset($proposals[$post_id]) ? $proposals[$post_id] : [];
            
            // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†
            if (function_exists('tcl_log_message')) {
                tcl_log_message("„Éî„É©„Éº„Éö„Éº„Ç∏Ê§úÂá∫: ID {$post_id}, „ÇØ„É©„Çπ„Çø„ÉºÊï∞: " . count($analysis['available_clusters']));
            }
        } else {
            // „ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            foreach ($proposals as $pillar_id => $clusters) {
                foreach ($clusters as $cluster) {
                    if ($cluster['cluster_id'] == $post_id) {
                        $analysis['is_in_cluster'] = true;
                        $analysis['is_pillar'] = false;
                        $analysis['pillar_id'] = $pillar_id;
                        $analysis['pillar_title'] = get_the_title($pillar_id);
                        break 2;
                    }
                }
            }
        }
        
        // Êó¢Â≠ò„É™„É≥„ÇØÊï∞„ÇíË®àÁÆó
        if ($analysis['is_in_cluster']) {
            $analysis['existing_links'] = $this->count_existing_links($post_id, $proposals);
            $analysis['remaining_links'] = max(0, $analysis['max_links'] - $analysis['existing_links']);
        }
        
        return $analysis;
    }
    
    /**
     * „ÇØ„É©„Çπ„Çø„Éº„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
     */
    private function display_no_cluster_message() {
        echo '<div class="tcl-status-box tcl-warning">';
        echo '<strong>üìù „Éà„Éî„ÉÉ„ÇØ„ÇØ„É©„Çπ„Çø„Éº„Çπ„ÉÜ„Éº„Çø„Çπ</strong><br>';
        echo '„Åì„ÅÆÊäïÁ®ø„ÅØ„Éà„Éî„ÉÉ„ÇØ„ÇØ„É©„Çπ„Çø„Éº„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>';
        echo '<div class="tcl-help-text">';
        echo '‚Ä¢ „Éî„É©„Éº„Éö„Éº„Ç∏„Çí‰ΩúÊàê„Åô„Çã„Å´„ÅØ„ÄÅACF„Åß„Äåpillar_keywords„Äç„Éï„Ç£„Éº„É´„Éâ„ÇíË®≠ÂÆö<br>';
        echo '‚Ä¢ Êó¢Â≠ò„ÅÆ„Éî„É©„Éº„Éö„Éº„Ç∏„Å´„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíËøΩÂä†„Åó„Å¶Èñ¢ÈÄ£‰ªò„Åë<br>';
        echo '‚Ä¢ <a href="' . admin_url('admin.php?page=topic-cluster-linker') . '" class="tcl-pillar-link">ÁÆ°ÁêÜÁîªÈù¢</a>„Åß„Äå„ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏ÂÜçÊèêÊ°à„Äç„ÇíÂÆüË°å';
        echo '</div>';
        echo '</div>';
    }
    
    /**
     * „ÇØ„É©„Çπ„Çø„Éº„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
     */
    private function display_cluster_status($analysis) {
        echo '<div class="tcl-status-box tcl-success">';
        echo '<strong>üìç „Éà„Éî„ÉÉ„ÇØ„ÇØ„É©„Çπ„Çø„ÉºÊÉÖÂ†±</strong><br>';
        
        if ($analysis['is_pillar']) {
            echo '<span style="background: #0073aa; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">PILLAR PAGE</span><br>';
            echo '„Åì„ÅÆ„Éö„Éº„Ç∏„ÅØ„Éî„É©„Éº„Éö„Éº„Ç∏„Åß„Åô';
            
            // „ÇØ„É©„Çπ„Çø„ÉºÊï∞„ÅÆË°®Á§∫
            $cluster_count = count($analysis['available_clusters']);
            echo '<br><small style="color: #666;">Èñ¢ÈÄ£„ÇØ„É©„Çπ„Çø„Éº: ' . $cluster_count . '‰ª∂</small>';
        } else {
            echo '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">CLUSTER PAGE</span><br>';
            echo 'Èñ¢ÈÄ£„Éî„É©„Éº: <a href="' . get_edit_post_link($analysis['pillar_id']) . '" target="_blank" class="tcl-pillar-link">' . esc_html($analysis['pillar_title']) . '</a>';
        }
        echo '</div>';
    }
    
    /**
     * „É™„É≥„ÇØÁµ±Ë®àË°®Á§∫
     */
    private function display_link_statistics($analysis) {
        echo '<div class="tcl-stats-grid">';
        
        echo '<div class="tcl-stat-item">';
        echo '<span class="tcl-stat-number">' . $analysis['existing_links'] . '/' . $analysis['max_links'] . '</span>';
        echo '<span>Ë®≠ÂÆöÊ∏à„Åø„É™„É≥„ÇØ</span>';
        echo '</div>';
        
        echo '<div class="tcl-stat-item">';
        echo '<span class="tcl-stat-number">' . $analysis['remaining_links'] . '</span>';
        echo '<span>ËøΩÂä†ÂèØËÉΩ</span>';
        echo '</div>';
        
        echo '</div>';
    }
    
    /**
     * „É™„É≥„ÇØÂÄôË£úË°®Á§∫
     */
    private function display_link_candidates($post, $analysis) {
        if ($analysis['is_pillar']) {
            echo '<div class="tcl-section-title">üìã Êé®Â•®„ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏</div>';
            if (!empty($analysis['available_clusters'])) {
                $this->display_cluster_link_candidates($post, $analysis);
            } else {
                echo '<div class="tcl-no-clusters" style="text-align: center; padding: 20px; background: #f8f9fa; border: 1px dashed #dee2e6; border-radius: 6px;">';
                echo '<div style="font-size: 24px; margin-bottom: 10px;">üìÑ</div>';
                echo '<strong>Èñ¢ÈÄ£„Åô„Çã„ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</strong><br>';
                echo '<small style="color: #666; margin-top: 8px; display: block;">';
                echo '‚Ä¢ <a href="' . admin_url('admin.php?page=topic-cluster-linker') . '" class="tcl-pillar-link">ÁÆ°ÁêÜÁîªÈù¢</a>„Åß„Äå„ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏ÂÜçÊèêÊ°à„Äç„ÇíÂÆüË°å<br>';
                echo '‚Ä¢ Èñ¢ÈÄ£Ë®ò‰∫ã„Çí‰ΩúÊàê„Åô„Çã„Å®Ëá™ÂãïÁöÑ„Å´ÊèêÊ°à„Åï„Çå„Åæ„Åô';
                echo '</small>';
                echo '</div>';
            }
            
            // Êñ∞Ê©üËÉΩ: „ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏‰ΩúÊàêÊèêÊ°à„ÇíËøΩÂä†
            echo '<div class="tcl-section-title" style="margin-top: 25px;">üí° Êñ∞„Åó„ÅÑ„ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏„Çí‰ΩúÊàê</div>';
            $this->display_cluster_creation_suggestion($post, $analysis);
        }
        
        if (!$analysis['is_pillar']) {
            echo '<div class="tcl-section-title">üìå „Éî„É©„Éº„Éö„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØ</div>';
            $this->display_pillar_link_candidate($post, $analysis);
        }
    }
    
    /**
     * „ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØÂÄôË£úË°®Á§∫
     */
    private function display_cluster_link_candidates($post, $analysis) {
        $count = 0;
        $remaining = $analysis['remaining_links'];
        
        foreach ($analysis['available_clusters'] as $cluster) {
            if ($count >= $remaining) break;
            
            $cluster_post = get_post($cluster['cluster_id']);
            if (!$cluster_post) continue;
            
            echo '<div class="tcl-link-box" data-cluster-id="' . $cluster['cluster_id'] . '">';
            echo '<div class="tcl-link-title">' . esc_html($cluster_post->post_title) . '</div>';
            
            if (!empty($cluster['matched_keywords'])) {
                echo '<div class="tcl-keywords">üè∑Ô∏è ' . implode(', ', array_map('esc_html', $cluster['matched_keywords'])) . '</div>';
            }
            
            $link_text = $this->generate_link_text_safe($post, $cluster_post);
            
            echo '<div class="tcl-preview" id="preview-' . $cluster['cluster_id'] . '">' . $link_text . '</div>';
            
            echo '<div class="tcl-button-group">';
            echo '<button type="button" class="tcl-button tcl-button-primary insert-tcl-link" data-insert="' . esc_attr($link_text) . '" data-target-id="' . $cluster['cluster_id'] . '">';
            echo 'üîó ÊåøÂÖ•</button>';
            echo '<button type="button" class="tcl-button tcl-button-secondary tcl-reload" data-post-id="' . $post->ID . '" data-cluster-id="' . $cluster['cluster_id'] . '">';
            echo 'üîÑ ÂÜçÁîüÊàê</button>';
            echo '</div>';
            echo '</div>';
            
            $count++;
        }
        
        if ($count === 0) {
            echo '<div class="tcl-no-clusters">Âà©Áî®ÂèØËÉΩ„Å™„ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        }
    }
    
    /**
     * „Éî„É©„Éº„Éö„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØÂÄôË£úË°®Á§∫
     */
    private function display_pillar_link_candidate($post, $analysis) {
        $pillar_post = get_post($analysis['pillar_id']);
        if (!$pillar_post) return;
        
        echo '<div class="tcl-link-box" data-cluster-id="' . $analysis['pillar_id'] . '">';
        echo '<div class="tcl-link-title">' . esc_html($pillar_post->post_title) . '</div>';
        
        $link_text = $this->generate_link_text_safe($post, $pillar_post);
        
        echo '<div class="tcl-preview" id="preview-' . $analysis['pillar_id'] . '">' . $link_text . '</div>';
        
        echo '<div class="tcl-button-group">';
        echo '<button type="button" class="tcl-button tcl-button-primary insert-tcl-link" data-insert="' . esc_attr($link_text) . '" data-target-id="' . $analysis['pillar_id'] . '">';
        echo 'üîó ÊåøÂÖ•</button>';
        echo '<button type="button" class="tcl-button tcl-button-secondary tcl-reload" data-post-id="' . $post->ID . '" data-cluster-id="' . $analysis['pillar_id'] . '">';
        echo 'üîÑ ÂÜçÁîüÊàê</button>';
        echo '</div>';
        echo '</div>';
    }
    
    /**
     * ÊúÄÂ§ß„É™„É≥„ÇØÊï∞Âà∞ÈÅî„É°„ÉÉ„Çª„Éº„Ç∏
     */
    private function display_max_links_reached() {
        echo '<div class="tcl-status-box tcl-error">';
        echo '<strong>‚ö†Ô∏è „É™„É≥„ÇØ‰∏äÈôêÂà∞ÈÅî</strong><br>';
        echo '„Åì„ÅÆ„Éö„Éº„Ç∏„ÅØÊó¢„Å´ÊúÄÂ§ßÊï∞„ÅÆ„É™„É≥„ÇØ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br>';
        echo '<div class="tcl-help-text">';
        echo 'SEOÂäπÊûú„ÇíÊúÄÂ§ßÂåñ„Åô„Çã„Åü„ÇÅ„ÄÅ1ÊäïÁ®ø„ÅÇ„Åü„Çä„ÅÆ„É™„É≥„ÇØÊï∞„ÇíÂà∂Èôê„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ';
        echo '</div>';
        echo '</div>';
    }
    
    /**
     * „Éò„É´„Éó„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫
     */
    private function display_help_text() {
        echo '<div class="tcl-help-text" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">';
        echo '<strong>üí° ‰Ωø„ÅÑÊñπ„ÅÆ„Éí„É≥„Éà:</strong><br>';
        echo '‚Ä¢ „Äåüîó ÊåøÂÖ•„Äç„Åß„Ç®„Éá„Ç£„Çø„Å´„É™„É≥„ÇØ„ÇíËøΩÂä†<br>';
        echo '‚Ä¢ „ÄåüîÑ ÂÜçÁîüÊàê„Äç„ÅßAI„ÅåÊñ∞„Åó„ÅÑ„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„Éà„Çí‰ΩúÊàê<br>';
        echo '‚Ä¢ „É™„É≥„ÇØ„ÅØÊñáËÑà„Å´Âêà„Çè„Åõ„Å¶Ëá™ÂãïË™øÊï¥„Åï„Çå„Åæ„Åô<br>';
        echo '‚Ä¢ <a href="' . admin_url('admin.php?page=topic-cluster-linker') . '" class="tcl-pillar-link">ÁÆ°ÁêÜÁîªÈù¢</a>„ÅßÂÖ®‰Ωì„ÅÆÊßãÈÄ†„ÇíÁ¢∫Ë™ç';
        echo '</div>';
    }
    
    /**
     * Êó¢Â≠ò„É™„É≥„ÇØÊï∞„Çí„Ç´„Ç¶„É≥„Éà
     */
    private function count_existing_links($post_id, $proposals) {
        $content = get_post_field('post_content', $post_id);
        $count = 0;
        
        foreach ($proposals as $pillar_id => $clusters) {
            // „Éî„É©„Éº„Éö„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (strpos($content, get_permalink($pillar_id)) !== false) {
                $count++;
            }
            
            // „ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏„Å∏„ÅÆ„É™„É≥„ÇØ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            foreach ($clusters as $cluster) {
                if (strpos($content, get_permalink($cluster['cluster_id'])) !== false) {
                    $count++;
                }
            }
        }
        
        return min($count, get_option('tcl_max_links_per_post', 2));
    }
    
    /**
     * ÂÆâÂÖ®„Å™„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàê
     */
    private function generate_link_text_safe($post, $target_post) {
        if (function_exists('tcl_generate_contextual_link_text')) {
            $generated = tcl_generate_contextual_link_text(
                $post->post_content,
                $target_post->post_title,
                get_permalink($target_post->ID)
            );
            
            // „Ç®„É©„Éº„Åß„Å™„ÅÑÂ†¥Âêà„ÅØÁîüÊàê„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà„ÇíËøî„Åô
            if (strpos($generated, '„Ç®„É©„Éº') === false && strpos($generated, '‚ùå') === false) {
                return $generated;
            }
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Ç∑„É≥„Éó„É´„Å™„É™„É≥„ÇØ
        return sprintf(
            'Ë©≥„Åó„Åè„ÅØ<a href="%s">%s</a>„Çí„ÅîË¶ß„Åè„Å†„Åï„ÅÑ„ÄÇ',
            get_permalink($target_post->ID),
            esc_html($target_post->post_title)
        );
    }
    
    /**
     * „É°„Çø„Éú„ÉÉ„ÇØ„Çπ„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
     */
    public function save_metabox_data($post_id, $post) {
        // Ëá™Âãï‰øùÂ≠ò„ÇÑ„É™„Éì„Ç∏„Éß„É≥„Çí„Çπ„Ç≠„ÉÉ„Éó
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
        if (wp_is_post_revision($post_id)) return;
        
        // „Éä„É≥„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
        if (!isset($_POST['tcl_metabox_nonce_field']) || 
            !wp_verify_nonce($_POST['tcl_metabox_nonce_field'], 'tcl_metabox_nonce')) {
            return;
        }
        
        // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ
        if (!current_user_can('edit_post', $post_id)) return;
        
        if (function_exists('tcl_log_message')) {
            tcl_log_message("„É°„Çø„Éú„ÉÉ„ÇØ„Çπ‰øùÂ≠òÂá¶ÁêÜ: Post ID {$post_id}");
        }
    }
    
    /**
     * „ÇØ„É©„Çπ„Çø„Éº„Éö„Éº„Ç∏‰ΩúÊàêÊèêÊ°àË°®Á§∫Ôºà‰øÆÊ≠£ÁâàÔºâ
     */
    private function display_cluster_creation_suggestion($post, $analysis) {
        echo '<div class="tcl-cluster-creation-box">';
        
        // „Çª„ÇØ„Ç∑„Éß„É≥1: „ÇØ„É©„Çπ„Çø„Éº„Ç≠„Éº„ÉØ„Éº„ÉâÁîüÊàêÊñπÊ≥ïÔºà‰øÆÊ≠£ÁâàÔºâ
        echo '<div style="margin-bottom: 20px;">';
        echo '<h4 style="margin: 0 0 10px 0; color: #0073aa; font-size: 14px;">üéØ „ÇØ„É©„Çπ„Çø„Éº„Ç≠„Éº„ÉØ„Éº„ÉâÁîüÊàêÊñπÊ≥ï</h4>';
        echo '<p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">2„Å§„ÅÆÊñπÊ≥ï„Åã„ÇâÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
        
        echo '<button type="button" id="tcl-generate-keyword-map-basic" class="tcl-button tcl-button-secondary" style="width: 48%; margin-bottom: 10px; margin-right: 4%;" data-post-id="' . $post->ID . '">';
        echo 'ü§ñ AIÁîüÊàêÔºàÂü∫Êú¨Ôºâ';
        echo '</button>';
        
        echo '<button type="button" id="tcl-generate-keyword-map-advanced" class="tcl-button tcl-button-primary" style="width: 48%; margin-bottom: 10px;" data-post-id="' . $post->ID . '">';
        echo 'üîç Ê§úÁ¥¢„Éá„Éº„ÇøÈÄ£Êê∫ÔºàÊé®Â•®Ôºâ';
        echo '</button>';
        
        echo '<div id="tcl-keyword-map" style="display: none; margin-top: 10px;"></div>';
        echo '</div>';
        
        // „Çª„ÇØ„Ç∑„Éß„É≥2: Ë®ò‰∫ã„Ç¢„Ç§„Éá„Ç¢ÁîüÊàê
        echo '<div style="border-top: 1px solid #ddd; padding-top: 15px;">';
        echo '<h4 style="margin: 0 0 10px 0; color: #0073aa; font-size: 14px;">üí° ÂÖ∑‰ΩìÁöÑ„Å™Ë®ò‰∫ã„Ç¢„Ç§„Éá„Ç¢ÊèêÊ°à</h4>';
        echo '<p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">ÈÅ∏Êäû„Åó„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„Åã„ÇâÂÖ∑‰ΩìÁöÑ„Å™Ë®ò‰∫ã„ÇíÊèêÊ°à„Åó„Åæ„Åô</p>';
        
        echo '<button type="button" id="tcl-suggest-cluster-ideas" class="tcl-button tcl-button-secondary" style="width: 100%; margin-bottom: 10px;" data-post-id="' . $post->ID . '">';
        echo 'üìù Ë®ò‰∫ã„Ç¢„Ç§„Éá„Ç¢ÁîüÊàê';
        echo '</button>';
        
        echo '<div id="tcl-cluster-suggestions" style="display: none; margin-top: 10px;"></div>';
        echo '</div>';
        
        echo '</div>';
        
        // JavaScriptËøΩÂä†
        $this->add_cluster_suggestion_script();
    }
    
    /**
     * „ÇØ„É©„Çπ„Çø„ÉºÊèêÊ°àÁî®JavaScriptÔºà‰øÆÊ≠£ÁâàÔºâ
     */
    private function add_cluster_suggestion_script() {
        ?>
        <script>
        jQuery(document).ready(function($) {
            // „Ç≠„Éº„ÉØ„Éº„Éâ„Éû„ÉÉ„ÉóÁîüÊàêÔºàÂü∫Êú¨ÁâàÔºâ
            $('#tcl-generate-keyword-map-basic').on('click', function() {
                const $button = $(this);
                const postId = $button.data('post-id');
                const originalText = $button.text();
                
                $button.text('ü§ñ AIÂàÜÊûê‰∏≠...').prop('disabled', true);
                
                $.ajax({
                    url: ajaxurl,
                    method: 'POST',
                    data: {
                        action: 'tcl_generate_keyword_map',
                        post_id: postId,
                        nonce: $('#tcl_metabox_nonce_field').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            displayKeywordMap(response.data);
                            $('#tcl-keyword-map').show();
                        } else {
                            alert('„Ç®„É©„Éº: ' + response.data);
                        }
                    },
                    error: function() {
                        alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                    },
                    complete: function() {
                        $button.text(originalText).prop('disabled', false);
                    }
                });
            });
            
            // „Ç≠„Éº„ÉØ„Éº„Éâ„Éû„ÉÉ„ÉóÁîüÊàêÔºàÈ´òÂ∫¶ÁâàÔºâ
            $('#tcl-generate-keyword-map-advanced').on('click', function() {
                const $button = $(this);
                const postId = $button.data('post-id');
                const originalText = $button.text();
                
                $button.text('üîç Ê§úÁ¥¢„Éá„Éº„ÇøÂèñÂæó‰∏≠...').prop('disabled', true);
                
                $.ajax({
                    url: ajaxurl,
                    method: 'POST',
                    data: {
                        action: 'tcl_generate_keyword_map_advanced',
                        post_id: postId,
                        nonce: $('#tcl_metabox_nonce_field').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            displayKeywordMap(response.data);
                            $('#tcl-keyword-map').show();
                        } else {
                            alert('„Ç®„É©„Éº: ' + response.data);
                        }
                    },
                    error: function() {
                        alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                    },
                    complete: function() {
                        $button.text(originalText).prop('disabled', false);
                    }
                });
            });
            
            // Ë®ò‰∫ã„Ç¢„Ç§„Éá„Ç¢ÁîüÊàê
            $('#tcl-suggest-cluster-ideas').on('click', function() {
                const $button = $(this);
                const postId = $button.data('post-id');
                const originalText = $button.text();
                
                // ÈÅ∏Êäû„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂèñÂæó
                const selectedKeywords = [];
                $('.keyword-checkbox:checked').each(function() {
                    selectedKeywords.push($(this).val());
                });
                
                if (selectedKeywords.length === 0) {
                    alert('Ë®ò‰∫ã„Å´„Åó„Åü„ÅÑ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖà„Å´ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                $button.text('ü§ñ Ë®ò‰∫ã„Ç¢„Ç§„Éá„Ç¢ÁîüÊàê‰∏≠...').prop('disabled', true);
                
                $.ajax({
                    url: ajaxurl,
                    method: 'POST',
                    data: {
                        action: 'tcl_suggest_cluster_ideas',
                        post_id: postId,
                        selected_keywords: selectedKeywords,
                        nonce: $('#tcl_metabox_nonce_field').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            displayClusterSuggestions(response.data);
                            $('#tcl-cluster-suggestions').show();
                        } else {
                            alert('„Ç®„É©„Éº: ' + response.data);
                        }
                    },
                    error: function() {
                        alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                    },
                    complete: function() {
                        $button.text(originalText).prop('disabled', false);
                    }
                });
            });
            
          // „É™„É≥„ÇØÊåøÂÖ•Ê©üËÉΩ
           $(document).on('click', '.insert-tcl-link', function() {
               const linkText = $(this).data('insert');
               
               if (typeof tinymce !== 'undefined' && tinymce.activeEditor) {
                   // „Éì„Ç∏„É•„Ç¢„É´„Ç®„Éá„Ç£„Çø„Å´ÊåøÂÖ•
                   tinymce.activeEditor.execCommand('mceInsertContent', false, linkText);
                   alert('üîó „É™„É≥„ÇØ„ÇíÊåøÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ');
               } else {
                   // „ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„Çø„Å´ÊåøÂÖ•
                   const textarea = document.getElementById('content');
                   if (textarea) {
                       const cursorPos = textarea.selectionStart;
                       const textBefore = textarea.value.substring(0, cursorPos);
                       const textAfter = textarea.value.substring(cursorPos);
                       textarea.value = textBefore + '\n\n' + linkText + '\n\n' + textAfter;
                       alert('üîó „É™„É≥„ÇØ„ÇíÊåøÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ');
                   } else {
                       // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                       if (navigator.clipboard) {
                           navigator.clipboard.writeText(linkText).then(function() {
                               alert('üìã „É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅÊâãÂãï„Åß„Ç®„Éá„Ç£„Çø„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                           });
                       } else {
                           alert('„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„Éà: ' + linkText);
                       }
                   }
               }
           });
           
           // „É™„É≥„ÇØÂÜçÁîüÊàêÊ©üËÉΩ
           $(document).on('click', '.tcl-reload', function() {
               const $button = $(this);
               const postId = $button.data('post-id');
               const clusterId = $button.data('cluster-id');
               const originalText = $button.text();
               
               $button.text('üîÑ ÁîüÊàê‰∏≠...').prop('disabled', true);
               
               $.ajax({
                   url: ajaxurl,
                   method: 'POST',
                   data: {
                       action: 'tcl_regenerate_link',
                       post_id: postId,
                       cluster_id: clusterId,
                       nonce: $('#tcl_metabox_nonce_field').val()
                   },
                   success: function(response) {
                       if (response.success) {
                           const $preview = $('#preview-' + clusterId);
                           const $insertButton = $button.siblings('.insert-tcl-link');
                           
                           $preview.html(response.data.text);
                           $insertButton.data('insert', response.data.text);
                           
                           // „Éú„Çø„É≥„ÇíÂ∞ë„ÅóÂÖâ„Çâ„Åõ„Çã„Ç®„Éï„Çß„ÇØ„Éà
                           $preview.css('background', '#e8f4fd').animate({backgroundColor: 'white'}, 1000);
                       } else {
                           alert('„Ç®„É©„Éº: ' + response.data);
                       }
                   },
                   error: function() {
                       alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                   },
                   complete: function() {
                       $button.text(originalText).prop('disabled', false);
                   }
               });
           });
           
           // „Ç≠„Éº„ÉØ„Éº„Éâ„Éû„ÉÉ„ÉóË°®Á§∫
           function displayKeywordMap(data) {
               const $container = $('#tcl-keyword-map');
               let html = '<div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px;">';
               
               if (data.keyword_categories) {
                   html += '<div style="margin-bottom: 15px; padding: 10px; background: #e8f4fd; border-left: 3px solid #0073aa;">';
                   html += '<strong>üéØ Á∑è„Ç≠„Éº„ÉØ„Éº„ÉâÊï∞: ' + data.total_keywords + 'ÂÄã</strong><br>';
                   html += '<small>Ê§úÁ¥¢„Éú„É™„É•„Éº„É†„Å®Á´∂Âêà„É¨„Éô„É´„ÇíËÄÉÊÖÆ„Åó„Å¶ÂÑ™ÂÖàÂ∫¶‰ªò„Åë„Åó„Å¶„ÅÑ„Åæ„Åô</small>';
                   html += '</div>';
                   
                   Object.keys(data.keyword_categories).forEach(function(category) {
                       const keywords = data.keyword_categories[category];
                       if (keywords.length > 0) {
                           html += '<div style="margin-bottom: 20px;">';
                           html += '<h5 style="margin: 0 0 10px 0; color: #0073aa; font-size: 13px;">' + category + ' (' + keywords.length + 'ÂÄã)</h5>';
                           
                           keywords.forEach(function(keyword, index) {
                               const priority = keyword.priority || 'medium';
                               const priorityColor = priority === 'high' ? '#28a745' : priority === 'medium' ? '#ffc107' : '#6c757d';
                               const difficultyText = keyword.difficulty || '‰∏çÊòé';
                               const keywordId = 'kw-' + category.replace(/[^a-zA-Z0-9]/g, '') + '-' + index;
                               
                               html += '<div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">';
                               html += '<input type="checkbox" class="keyword-checkbox" value="' + keyword.text + '" id="' + keywordId + '" style="margin-right: 8px;">';
                               html += '<label for="' + keywordId + '" style="flex: 1; font-size: 12px; cursor: pointer;">' + keyword.text + '</label>';
                               html += '<span style="font-size: 10px; padding: 2px 6px; background: ' + priorityColor + '; color: white; border-radius: 3px; margin-left: 8px;">ÂÑ™ÂÖàÂ∫¶: ' + priority + '</span>';
                               html += '<span style="font-size: 10px; color: #666; margin-left: 8px;">Èõ£ÊòìÂ∫¶: ' + difficultyText + '</span>';
                               html += '</div>';
                           });
                           
                           html += '</div>';
                       }
                   });
                   
                   // ‰∏ÄÊã¨ÈÅ∏Êäû„Éú„Çø„É≥
                   html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">';
                   html += '<button type="button" id="select-high-priority" style="margin-right: 8px; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">È´òÂÑ™ÂÖàÂ∫¶„ÇíÈÅ∏Êäû</button>';
                   html += '<button type="button" id="select-all-keywords" style="margin-right: 8px; padding: 4px 8px; background: #0073aa; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">ÂÖ®„Å¶ÈÅ∏Êäû</button>';
                   html += '<button type="button" id="clear-selection" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">ÈÅ∏ÊäûËß£Èô§</button>';
                   html += '<div style="margin-top: 8px; font-size: 11px; color: #666;">üí° Ë®ò‰∫ã„Å´„Åó„Åü„ÅÑ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„ÄåË®ò‰∫ã„Ç¢„Ç§„Éá„Ç¢ÁîüÊàê„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                   html += '</div>';
               }
               
               if (data.strategy_notes) {
                   html += '<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107;">';
                   html += '<strong>üí° „Ç≠„Éº„ÉØ„Éº„ÉâÊà¶Áï•„É°„É¢:</strong><br>' + data.strategy_notes;
                   html += '</div>';
               }
               
               html += '</div>';
               
               $container.html(html);
               
               // ‰∏ÄÊã¨ÈÅ∏ÊäûÊ©üËÉΩ
               $('#select-high-priority').on('click', function() {
                   $('.keyword-checkbox').prop('checked', false);
                   $('.keyword-checkbox').each(function() {
                       const $row = $(this).closest('div');
                       if ($row.find('span:contains("high")').length > 0) {
                           $(this).prop('checked', true);
                       }
                   });
               });
               
               $('#select-all-keywords').on('click', function() {
                   $('.keyword-checkbox').prop('checked', true);
               });
               
               $('#clear-selection').on('click', function() {
                   $('.keyword-checkbox').prop('checked', false);
               });
           }
           
           // Ë®ò‰∫ãÊèêÊ°àË°®Á§∫
           function displayClusterSuggestions(data) {
               const $container = $('#tcl-cluster-suggestions');
               let html = '<div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px;">';
               
               if (data.cluster_ideas && data.cluster_ideas.length > 0) {
                   html += '<h4 style="margin: 0 0 15px 0; color: #0073aa;">üìù ÊèêÊ°à„Åï„Çå„Åü„ÇØ„É©„Çπ„Çø„ÉºË®ò‰∫ã</h4>';
                   
                   data.cluster_ideas.forEach(function(idea, index) {
                       html += '<div style="border: 1px solid #e1e1e1; margin-bottom: 15px; padding: 12px; border-radius: 4px; background: #f9f9f9;">';
                       html += '<div style="font-weight: 600; color: #23282d; margin-bottom: 8px;">' + (index + 1) + '. ' + idea.title + '</div>';
                       
                       if (idea.keywords) {
                           html += '<div style="margin-bottom: 8px;"><strong>üè∑Ô∏è Áãô„ÅÑ„Ç≠„Éº„ÉØ„Éº„Éâ:</strong> ' + idea.keywords.join(', ') + '</div>';
                       }
                       
                       if (idea.outline) {
                           html += '<div style="margin-bottom: 8px;"><strong>üìã Ë®ò‰∫ãÊßãÊàê:</strong></div>';
                           html += '<ul style="margin: 0; padding-left: 20px; font-size: 12px;">';
                           idea.outline.forEach(function(point) {
                               html += '<li>' + point + '</li>';
                           });
                           html += '</ul>';
                       }
                       
                       if (idea.connection_strategy) {
                           html += '<div style="margin-top: 8px; font-size: 12px; color: #666;">';
                           html += '<strong>üîó ÂÜÖÈÉ®„É™„É≥„ÇØÊà¶Áï•:</strong> ' + idea.connection_strategy;
                           html += '</div>';
                       }
                       
                       html += '<div style="margin-top: 10px;">';
                       html += '<button type="button" class="tcl-copy-idea" data-title="' + idea.title + '" data-keywords="' + (idea.keywords ? idea.keywords.join(', ') : '') + '" style="font-size: 11px; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">üìã „Ç≥„Éî„Éº</button>';
                       html += '</div>';
                       
                       html += '</div>';
                   });
               }
               
               if (data.strategy_notes) {
                   html += '<div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-left: 3px solid #0073aa;">';
                   html += '<strong>üí° Êà¶Áï•„É°„É¢:</strong><br>' + data.strategy_notes;
                   html += '</div>';
               }
               
               html += '</div>';
               
               $container.html(html);
               
               // „Ç≥„Éî„ÉºÊ©üËÉΩ
               $('.tcl-copy-idea').on('click', function() {
                   const title = $(this).data('title');
                   const keywords = $(this).data('keywords');
                   const copyText = 'Ë®ò‰∫ã„Çø„Ç§„Éà„É´: ' + title + '\n„Ç≠„Éº„ÉØ„Éº„Éâ: ' + keywords;
                   
                   if (navigator.clipboard) {
                       navigator.clipboard.writeText(copyText).then(function() {
                           alert('üìã Ë®ò‰∫ã„Ç¢„Ç§„Éá„Ç¢„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
                       });
                   } else {
                       // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                       const textArea = document.createElement('textarea');
                       textArea.value = copyText;
                       document.body.appendChild(textArea);
                       textArea.select();
                       document.execCommand('copy');
                       document.body.removeChild(textArea);
                       alert('üìã Ë®ò‰∫ã„Ç¢„Ç§„Éá„Ç¢„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
                   }
               });
           }
       });
       </script>
       <?php
   }
   
   /**
    * „É°„Çø„Éú„ÉÉ„ÇØ„ÇπÁî®„Ç¢„Çª„ÉÉ„ÉàË™≠„ÅøËæº„Åø
    */
   public function enqueue_metabox_assets($hook) {
       if (!in_array($hook, ['post.php', 'post-new.php'])) {
           return;
       }
       
       wp_add_inline_style('wp-admin', '
           #tcl-cluster-links .inside { padding: 0; }
           #tcl-cluster-links .tcl-metabox-container { padding: 12px; }
       ');
       
       // jQuery UI for animations
       wp_enqueue_script('jquery-ui-effects-core');
       wp_enqueue_script('jquery-effects-highlight');
   }
}

// „É°„Çø„Éú„ÉÉ„ÇØ„Çπ„ÇØ„É©„Çπ„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„ÇπÂåñ
new TCL_Metabox();